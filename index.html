<!DOCTYPE html>
<meta charset="utf-8">
<title>Cartogram Generator</title>
<style>
body { font-family: sans-serif; }
#controls { margin: 1em 0; }
.land { fill: #eee; stroke: #999; }
.state { fill: steelblue; stroke: #fff; }
</style>
<div id="controls">
  <input type="file" id="csv" accept=".csv" />
  <button id="generate">Generate Cartogram</button>
</div>
<svg width="960" height="600"></svg>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://unpkg.com/topojson-client@3"></script>
<script>
const svg = d3.select("svg");
const path = d3.geoPath().projection(d3.geoAlbersUsa().scale(1000).translate([480,300]));
let baseStates;

d3.json("us.json").then(us => {
  baseStates = topojson.feature(us, us.objects.states).features;
  svg.append("g").attr("id","states")
     .selectAll("path")
     .data(baseStates)
     .enter().append("path")
     .attr("class","state")
     .attr("d", path);
});

document.getElementById('generate').addEventListener('click', () => {
  const file = document.getElementById('csv').files[0];
  if (!file) { alert('Please choose a CSV file.'); return; }
  const formData = new FormData();
  formData.append('file', file);
  fetch('/cartogram', { method: 'POST', body: formData })
    .then(r => {
      if (!r.ok) throw new Error('Error generating cartogram');
      return r.json();
    })
    .then(geojson => {
      svg.select('#states').selectAll('path')
        .data(geojson.features, d => d.properties.id)
        .transition().duration(750)
        .attr('d', path);
    })
    .catch(err => alert(err));
});
</script>
